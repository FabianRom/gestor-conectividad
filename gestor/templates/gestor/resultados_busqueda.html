{% extends 'gestor/base.html' %}
{% load static %}

{% block title %}Resultados de Búsqueda{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <a href="{% url 'busqueda' %}" class="btn btn-outline-secondary btn-sm shadow-sm">
        <i class="fas fa-arrow-left me-1"></i> Volver a la Búsqueda
    </a>
    <a href="{% url 'exportar_resultados' %}?{{ request.GET.urlencode }}" class="btn btn-success btn-sm shadow-sm" title="Exportar a Excel">
    <i class="fas fa-file-excel me-1"></i> Exportar
    </a>
</div>

<h1 class="page-header-results mb-4">
    <i class="fas fa-list-alt me-2"></i> {{ encabezado_resultado }}
</h1>

{# Mostrar filtros seleccionados - SIMPLIFICADO para no usar custom filters #}
<div class="mb-4 p-3 filter-display-box rounded">
    <span class="fw-bold me-2 text-dark">Filtros Aplicados:</span>
    {% if request.GET %}
        {% for key, value in request.GET.items %}
            {% if value and key != 'page' %} {# Ignoramos el parámetro 'page' #}
                {% if key == 'cue' or key == 'nombre' or key == 'predio_numero' %}
                    <span class="badge filter-badge bg-secondary">{{ key|capfirst }}: {{ value }}</span>
                {% elif key == 'region' or key == 'distrito' or key == 'dependencia' or key == 'categoria' %}
                    {# Para estos campos, asumimos que 'value' es el ID. Para mostrar el nombre completo, necesitarías el contexto del modelo en la vista. #}
                    <span class="badge filter-badge bg-info text-dark">{{ key|capfirst }}: {{ value }}</span>
                {% elif key == 'conectividad' or key == 'piso_tecnologico' or key == 'tiene_internet' or key == 'enlace_activo' %}
                    <span class="badge filter-badge bg-primary">{{ key|capfirst|slice:":12" }}: {{ value|upper }}</span>
                {% else %}
                    {# Para otros filtros no cubiertos específicamente #}
                    <span class="badge filter-badge bg-light text-dark">{{ key|capfirst }}: {{ value }}</span>
                {% endif %}
            {% endif %}
        {% endfor %}
    {% else %}
        <span class="text-muted small">No se aplicaron filtros. Mostrando todos los registros.</span>
    {% endif %}
</div>

{% if resultados %}
<div class="card shadow-lg">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-striped table-hover align-middle table-sm mb-0 results-table">
                <thead class="table-dark sticky-top">
                    <tr>
                        <th scope="col" class="text-center">CUE</th>
                        <th scope="col">Nombre del Establecimiento</th>
                        <th scope="col">Región</th>
                        <th scope="col">Distrito</th>
                        <th scope="col" class="text-center">Predio</th>
                        <th scope="col" class="text-center">Internet</th>
                        <th scope="col" class="text-center">Piso Tec.</th>
                        <th scope="col" class="text-center">Detalles</th>
                    </tr>
                </thead>
                <tbody>
                    {% for escuela in resultados %}
                    <tr class="result-row">
                        <td class="text-center fw-bold text-primary">{{ escuela.cue }}</td>
                        <td>
                            <a href="{% url 'detalle_escuela' escuela.cue %}" class="text-decoration-none text-dark-hover">
                                {{ escuela.nombre }}
                            </a>
                        </td>
                        <td>{{ escuela.region.nombre|default:"N/A" }}</td>
                        <td>{{ escuela.distrito.nombre|default:"N/A" }}</td>
                        <td class="text-center">{{ escuela.predio.numero_predio|default:"N/A" }}</td>
                        <td class="text-center">
                            {% if escuela.tiene_internet %}
                                <span class="badge badge-status bg-success" title="Con Conectividad">SÍ</span>
                            {% else %}
                                <span class="badge badge-status bg-danger" title="Sin Conectividad">NO</span>
                            {% endif %}
                        </td>
                        <td class="text-center">
                            {% if escuela.tiene_piso_tecnologico %}
                                <span class="badge badge-status bg-primary" title="Con Piso Tecnológico">SÍ</span>
                            {% else %}
                                <span class="badge badge-status bg-warning text-dark" title="Sin Piso Tecnológico">NO</span>
                            {% endif %}
                        </td>
                        <td class="text-center">
                            <a href="{% url 'detalle_escuela' escuela.cue %}"
                                class="btn btn-sm btn-outline-info p-1 px-2"
                                title="Ver Detalle">
                                <i class="fas fa-eye"></i>
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

{# Paginación (si aplica) #}
<div class="d-flex justify-content-center mt-4">
    {# Asume que aquí incluyes tu template de paginación #}
    {% include 'gestor/includes/pagination.html' %} 
</div>

{% else %}
<div class="alert alert-warning mt-4 text-center rounded-3 shadow-sm" role="alert">
    <i class="fas fa-info-circle me-2"></i>
    **¡Búsqueda sin resultados!** No se encontraron establecimientos que coincidan con los filtros aplicados.
    <a href="{% url 'busqueda' %}" class="alert-link ms-2">Intente con otra búsqueda.</a>
</div>
{% endif %}
{% endblock %}